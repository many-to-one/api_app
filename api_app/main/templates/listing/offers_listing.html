{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    {% block content %}

    <div class="of-l">

        <!-- <div class="of-l-nav">
            <div class="card pos_fixed">
                <div class="card-body">
                  {% for sub in sub_categories %}
                  {% for s in sub.categories %}
                    <p>{{s.name}}</p>
                    {% endfor %}
                  {% endfor %}  

                </div>
              </div>
        </div> -->

        <div class="accordion accordion-flush of-l-nav" id="accordionFlushExample" data-subcategories="{{ categories|safe }}">
            {% for cat in categories %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ cat.id }}">
                        <button 
                            class="accordion-button collapsed" 
                            type="button" data-bs-toggle="collapse" 
                            data-bs-target="#flush-collapse-{{ cat.id }}" 
                            aria-expanded="false" 
                            aria-controls="flush-collapse-{{ cat.id }}"
                            onclick="offersByCategory('{{ cat.id }}')"
                        >
                            {{ cat.name }}
                        </button>
                    </h2>
        
                    <div id="flush-collapse-{{ cat.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
                        {% for sub in sub_categories %}
                            {% for s in sub.categories %}
                                {% if cat.id == s.parent.id %}
                                    <div 
                                        class="accordion-body"
                                    >
                                        <li class="accordion_name" id="subCatBody" onclick="toggleFirst('{{ s.id }}')"> {{ s.name }} ▼
                                            <ul id="first">
                                                <li class="accordion_name" onclick="toggleSecond(event)">
                                                    <ul id="second">
                                                        <li class="accordion_name"><a href="/js-course" id="second_val"></a></li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>                                  
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
        

        <div class="of-l-table">

            <div class="of-tab-s">               
                <div class="serach_">
                    <div class="input-group search_fixed">
                        <input type="text" class="form-control" id="searchInput">
                        <select class="btn btn-outline-secondary dropdown-toggle s_btn" id="dropdown" onchange="showFilters()">
                            <option class="dropdown-item" href="#" data-option="phrase" selected>Nazwa Oferty</option>
                            <option class="dropdown-item" href="#" data-option="seller.login">Login Sprzedawcy</option>
                            <option class="dropdown-item" href="#" data-option="category.id">ID Kategorii</option>
                            <option class="dropdown-item" href="#" data-option="deliveryMethod">Dostawca</option>
                            <option class="dropdown-item" href="#" data-option="location.city">Miasto</option>
                            <option class="dropdown-item" href="#" data-option="location.province">Wojewódstwo</option>
                            <option class="dropdown-item" href="#" data-option="price.from&price.to">Zakres Cen</option>
                            <option class="dropdown-item" href="#" data-option="Darmowa Dostawa">Darmowa Dostawa</option>
                            <option class="dropdown-item" href="#" data-option="campaign">W Promocji</option>
                            <option class="dropdown-item" href="#" data-option="Konto Firmowe">Konto Firmowe</option>
                            <option class="dropdown-item" href="#" data-option="Super Sprzedawca">Super Sprzedawca</option>
                        </select>
                      </div>
                </div>
                
                <div class="table_">

                    <ul class="nav nav-tabs">
                      <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Active</a>
                      </li>
                    </ul>

                    <table class="table" id="offersTable">
                        <thead>
                          <tr>
                            <th scope="col">ID</th>
                            <th scope="col"></th>
                            <th scope="col">Tytuł</th>
                            <th scope="col">Cena</th>
                            <th scope="col">Sprzedawca</th>
                          </tr>
                        </thead>
                        <tbody id="tableBody">
                            {% for res in result.items.regular %}
                                <tr>
                                    <th scope="row">{{ res.id }}</th>
                                    <td>
                                        <img src="{{ res.images.0.url }}" alt="" width="50px">
                                    </td>
                                    <td>{{ res.name }}</td>
                                    <td>{{ res.sellingMode.price.amount }}</td>
                                    <td>{{ res.seller.login }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                      </table>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>
    <script src=
"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
    </script>

    <script>

        // Function to get CSRF token from cookie
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Check if the cookie name matches the desired name
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // document.addEventListener('DOMContentLoaded', function() {
        //     // Pobierz element z atrybutem 'data-subcategories'
        //     const accordionElement = document.getElementById('accordionFlushExample');

        //     // Odczytaj dane z atrybutu 'data-subcategories'
        //     const subCategoriesData = accordionElement.getAttribute('data-subcategories');

        //     // Parsuj dane JSON, jeśli są zapisane jako JSON
        //     // const subCategories = JSON.parse(subCategoriesData);

        //     // Wyświetl wynik w konsoli
        //     console.log('subCategoriesData', subCategoriesData);
        // })


        // Function to toggle the first nested list
        function toggleFirst(catId) {
            var firstList = document.getElementById("first");
            if (firstList.style.display === "block") {
                firstList.style.display = "none";
            } else {
                firstList.style.display = "block";
                offersBySubCategory(catId)
            }

        }


        // Function to toggle the second nested list
        function toggleSecond(event) {
            event.stopPropagation(); // Prevent the first list from closing when second is clicked
            var secondList = document.getElementById("second");
            if (secondList.style.display === "block") {
                secondList.style.display = "none";
            } else {
                secondList.style.display = "block";
                offersBySubCategory(catId)
            }
        }



        function offersByCategory(catId) {

            var csrftoken = getCookie('csrftoken')
            console.log('catId clicked', catId)

            axios.post('/offers_listing_response/', { filter: 'category.id', value: catId, name: 'retset' }, {
                headers: {
                        'X-CSRFToken': csrftoken
                    }
            })
            .then(function(response) {
                console.log('offers_listing_response', response)
                if ( response.status === 200 ) {
                    updateTable(response.data.result.items.regular)
                }
            })
            .catch(error => {
                // Handle error
                console.error('chatbot_response error!', error);
            });

        }


        function offersBySubCategory(catId) {

            var csrftoken = getCookie('csrftoken')
            console.log('offersBySubCategory clicked', catId)

            axios.post('/offers_listing_response/', { filter: 'category.id', value: catId, name: 'retset' }, {
                headers: {
                        'X-CSRFToken': csrftoken
                    }
            })
            .then(function(response) {
                console.log('offers_listing_response', response)
                if ( response.status === 200 ) {
                    updateTable(response.data.result.items.regular)
                    updateFilters(response.data.result.categories.subcategories)
                }
            })
            .catch(error => {
                // Handle error
                console.error('chatbot_response error!', error);
            });

        }


        function updateFilters(data) {

            var subCatBody = document.getElementById('subCatBody');
            subCatBody.innerHTML = '';

            var firstUl = document.createElement('ul');
            firstUl.id = 'first';

            data.forEach(function(item) {

                var nestedLi = document.createElement('li');
                nestedLi.className = 'accordion_name';
                nestedLi.onclick = function(event) { toggleSecond(event); };

                nestedLi.innerHTML =  `${item.name}`;

                firstUl.appendChild(nestedLi);
                subCatBody.appendChild(firstUl);

            })

        }



        function showFilters() {

            var csrftoken = getCookie('csrftoken')
            var filters = document.getElementById('dropdown');
            var inputValue = document.getElementById('searchInput').value;

            if ( filters.style.display === 'block') {
                filters.style.display = 'none'
            } else {
                filters.style.display = 'block'
            }

            var selectedOption = filters.selectedOptions[0];
            var dataOptionValue = selectedOption.getAttribute('data-option');
            console.log('showFilters optionSelect clicked', dataOptionValue, inputValue)

            axios.post('/offers_listing_response/', { filter: dataOptionValue, value: inputValue, name: 'retset' }, {
                headers: {
                        'X-CSRFToken': csrftoken
                    }
            })
            .then(function(response) {
                console.log('offers_listing_response', response)
                if ( response.status === 200 ) {
                    updateTable(response.data.result.items.regular)
                }
            })
            .catch(error => {
                // Handle error
                console.error('chatbot_response error!', error);
            });

        }


        function updateTable(data) {
            // Select the table body element
            var tableBody = document.getElementById('tableBody');

            // Clear any existing rows
            tableBody.innerHTML = '';

            // Loop through new data and add rows
            data.forEach(function(item) {
                var row = document.createElement('tr');
                
                // Create cells and populate them with data
                var idCell = document.createElement('th');
                idCell.setAttribute('scope', 'row');
                idCell.innerText = item.id;
                
                var imgCell = document.createElement('td');
                var img = document.createElement('img');
                img.src = item.images[0].url;
                img.width = 50;
                imgCell.appendChild(img);
                
                var titleCell = document.createElement('td');
                titleCell.innerText = item.name;
                
                var priceCell = document.createElement('td');
                priceCell.innerText = item.sellingMode.price.amount;
                
                var sellerCell = document.createElement('td');
                sellerCell.innerText = item.seller.login;

                // Append cells to the row
                row.appendChild(idCell);
                row.appendChild(imgCell);
                row.appendChild(titleCell);
                row.appendChild(priceCell);
                row.appendChild(sellerCell);

                // Append the row to the table body
                tableBody.appendChild(row);
            });
        }


    </script>

    {% endblock %}
    
</body>
</html>