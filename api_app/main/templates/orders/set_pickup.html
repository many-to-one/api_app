{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <title>Document</title>
</head>
<body>
    {% block content %}

        <h3 id="seller" data-value="{{ name }}">Przetwarzam zamówienia, proszę czekać..</h3>
        <!-- {% for res in result %}
            <div 
                name="link"
                value="{{ res.commandId }}:{{ res.name }}"
            >

            </div>
        {% endfor %} -->

        <div name="link" value="{{ result }}"></div>

        <div id="question">
            <p id="text"></p>

            <div class="btns_cont">

                <button onclick="getNo()">Bez podjazdu</button>
        
                <div class="d-flex flex-column">
                    <p>Zamów podjazd kuriera:</p>
                    <div class="form-group">
                        <label for="date">Data podjazdu:</label>
                        <input type="text" class="form-control" id="datepicker" name="date">
                    </div>
                    <br>
                    <br>
                    <div class="p-2 w-100">
                        <div style="display: flex; gap: 10px;">
                            <div class="p-2">DPD</div>
                            <div class="p-2">
                                <select id="dpd" class="form-select mb-2 w-100" aria-label="Default select example" onchange="dpdSelectedValue()">
                                    <option selected>godziny podjazdu</option>
                                    <option value="10:00 - 12:00">10:00 - 12:00</option>
                                    <option value="12:00 - 14:00">12:00 - 14:00</option>
                                    <option value="14:00 - 16:00">14:00 - 16:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <br>
    
                    <div class="p-2 w-100">
                        <div style="display: flex; gap: 10px;">
                            <div class="p-2">DHL</div>
                            <div class="p-2">
                                <select class="form-select mb-2 w-100" aria-label="Default select example">
                                    <option selected>godziny podjazdu</option>
                                    <option value="1">10:00 - 12:00</option>
                                    <option value="2">12:00 - 14:00</option>
                                    <option value="3">14:00 - 16:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <br>
    
                    <div class="p-2 w-100">
                        <div style="display: flex; gap: 10px;">
                            <div class="p-2">UPS</div>
                            <div class="p-2">
                                <select class="form-select mb-2 w-100" aria-label="Default select example">
                                    <option selected>godziny podjazdu</option>
                                    <option value="1">10:00 - 12:00</option>
                                    <option value="2">12:00 - 14:00</option>
                                    <option value="3">14:00 - 16:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <br>
    
                    <div class="p-2 w-100"></div>
                        <div style="display: flex; gap: 10px;">
                            <div class="p-2">Orlen</div>
                            <div class="p-2">
                                <select class="form-select mb-2 w-100" aria-label="Default select example">
                                    <option selected>godziny podjazdu</option>
                                    <option value="1">10:00 - 12:00</option>
                                    <option value="2">12:00 - 14:00</option>
                                    <option value="3">14:00 - 16:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <br>
    
                </div>
                <br>
                <button onclick="setToSend(event)">Zamów</button>
                    

            </div>


                
        </div>

        <div id="wait">
            <p>Proczę czekać...</p>
            <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
        </div>



        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>

        <script>

            const dpdCont = []

            $(document).ready(function(){
                $('#datepicker').datepicker({
                    format: 'yyyy-mm-dd',  // Adjust the format to your preference
                    autoclose: true,
                    todayHighlight: true
                });
            });

            function dpdSelectedValue() {
                var dpdSelect = document.getElementById("dpd");
                var selectedValue = dpdSelect.value;
                console.log("Selected value: " + selectedValue);
                dpdCont.push({'DPD': selectedValue})
            }

            function getCSRFToken() {
                const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/)[1];
                return cookieValue;
            }
            
            // Axios configuration to include CSRF token in headers
            axios.defaults.xsrfCookieName = 'csrftoken';
            axios.defaults.xsrfHeaderName = 'X-CSRFToken';
            axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';

            document.addEventListener('DOMContentLoaded', function() {
                var question = document.getElementById('question')
                var text = document.getElementById('text')

                question.style.display = 'flex';
                text.innerHTML = '';
                text.textContent = "Wybierz opcje";
            });

            function setToSend(event) {

                var wait = document.getElementById('wait');
                wait.style.display = 'flex';

                var question = document.getElementById('question')
                question.style.display = 'flex';

                var datepicker_ = document.getElementById("datepicker").value;

                var seller = document.getElementById('seller').getAttribute('data-value');

                var links = document.querySelectorAll('div[name="link"]');

                var context = [];
                links.forEach(function(link) {
                    var value = link.getAttribute('value');
                    console.log('value:', value);
                    let cleanedValue = value
                    .replace(/None/g, 'null')       // Replace None with null
                    .replace(/'/g, '"')             // Replace single quotes with double quotes
                    .replace(/\(\{/g, '{')          // Remove tuple notation (e.g., ( becomes { )
                    .replace(/\}\)/g, '}')
                    .replace(/True/g, 'true')        // Replace True with true
                    .replace(/False/g, 'false');
                    let parsedValue;
                    parsedValue = JSON.parse(cleanedValue);
                    console.log('parsedValue:', parsedValue);
                    context.push({ parsedValue });
                    // let commandId = parsedValue[0] ? parsedValue[0].commandId : null;
                    // console.log('commandId:', commandId, 'name:', seller);
                    // context.push({ commandId, seller });
                });

                console.log('context:', context[0]['parsedValue']);
                var serializedContext = JSON.stringify(context[0]['parsedValue']);

                var url = `/prepare_get_shipment_status_id/${seller}/?ids=` + encodeURIComponent(serializedContext) + '&pickup=' + 'pickup';
                window.location.href = url;
                wait.style.display = 'none';
                question.style.display = 'none';
                
            }


            function getNo() {

                var wait = document.getElementById('wait');
                wait.style.display = 'flex';

                var question = document.getElementById('question')
                question.style.display = 'flex';

                var seller = document.getElementById('seller').getAttribute('data-value');

                var links = document.querySelectorAll('div[name="link"]');

                var context = [];
                links.forEach(function(link) {
                    var value = link.getAttribute('value');
                    console.log('value:', value);
                    let cleanedValue = value
                    .replace(/None/g, 'null')       // Replace None with null
                    .replace(/'/g, '"')             // Replace single quotes with double quotes
                    .replace(/\(\{/g, '{')          // Remove tuple notation (e.g., ( becomes { )
                    .replace(/\}\)/g, '}')
                    .replace(/True/g, 'true')        // Replace True with true
                    .replace(/False/g, 'false');
                    let parsedValue;
                    parsedValue = JSON.parse(cleanedValue);
                    console.log('parsedValue:', parsedValue);
                    context.push({ parsedValue });
                    // let commandId = parsedValue[0] ? parsedValue[0].commandId : null;
                    // console.log('commandId:', commandId);
                    // context.push({ commandId, seller});
                });

                console.log('context:', context[0]['parsedValue']);
                var serializedContext = JSON.stringify(context[0]['parsedValue']);

                var url = `/prepare_get_shipment_status_id/${seller}/?ids=` + encodeURIComponent(serializedContext) + '&pickup=' + 'no_pickup';
                // var seller = document.getElementById('seller').getAttribute('data-value');
                // var url = '/get_orders/' + seller + '/';
                window.location.href = url;
                wait.style.display = 'none';
                question.style.display = 'none';

            }

        </script>
    
    {% endblock %}
</body>
</html>