{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <title>Document</title>
</head>
<body>
    {% block content %}

        <h3 id="seller" data-value="{{ name }}">Przetwarzam zamówienia, proszę czekać..</h3>

        <div name="link" value="{{ result }}"></div>
        <div name="couriers" value="{{ couriers }}"></div>

        <div id="question">
            <p id="text"></p>


            <div class="btns_cont">

            <div id="messageBox" class="message-box" style="display: none;">
                <span id="messageText"></span>
                <button id="closeButton" class="close-button" onclick="closeMessage()">&times;</button>
            </div>

                <button onclick="getNo()">Bez podjazdu</button>
        
                <div class="d-flex flex-column">
                    <p>Zamów podjazd kuriera:</p>
                    <div class="form-group">
                        <label for="date">Data podjazdu:</label>
                        <input type="text" class="form-control" id="datepicker" name="date">
                    </div>
                    <br>
                    <br>

                    <div class="p-2 w-100">
                        <div style="display: flex; gap: 10px;">

                            {% for courier, times in selects %}
                                <div class="p-2">{{ courier }}</div>
                                <div class="p-2">
                                    <select 
                                        id="{{ courier }}"
                                        class="form-select mb-2 w-100" 
                                        aria-label="Default select example"
                                        onchange="selectedCourierTime('{{ courier }}')"
                                    >   
                                        <option selected>godziny podjazdu</option>
                                        {% for time in times %}
                                            <option value="{{ time }}">{{ time }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <br>
                            {% endfor %}

                        </div>
                    </div>

                </div>
                <br>
                <button onclick="setToSend(event)">Zamów</button>
                    

            </div>


                
        </div>

        <div id="wait">
            <p>Proczę czekać...</p>
            <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
        </div>



        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>

        <script>

        function showMessage(message, status) {
            console.log('showMessage', message, status)
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;
            messageBox.style.display = 'block';  
            if ( status === 200 ) {
                messageBox.style.backgroundColor = 'green';
            } else if ( status === 300 ) {
                messageBox.style.backgroundColor = 'blue';
            } else {
                messageBox.style.backgroundColor = 'red';
            }

            setTimeout(closeMessage, 3000);
        }

        function closeMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.style.display = 'none';  // Hide the message box
        }

            const pickupCont = []

            $(document).ready(function(){
                $('#datepicker').datepicker({
                    format: 'yyyy-mm-dd',  // Adjust the format to your preference
                    autoclose: true,
                    todayHighlight: true
                });
            });

        
            function selectedCourierTime(courier) {
                // console.log("selectedCourierTime:", courier );
                var couriers = document.querySelectorAll('div[name="couriers"]');
                var selectedCourier = document.getElementById(courier);
                var selectedValue = selectedCourier.value;
                for(let name of couriers) {
                    var courierNames = name.getAttribute('value');
                    let cleanedValue = courierNames
                    .replace(/None/g, 'null')       // Replace None with null
                    .replace(/'/g, '"')             // Replace single quotes with double quotes
                    .replace(/\(\{/g, '{')          // Remove tuple notation (e.g., ( becomes { )
                    .replace(/\}\)/g, '}')
                    .replace(/True/g, 'true')        // Replace True with true
                    .replace(/False/g, 'false');
                    let parsedValue;
                    parsedValue = JSON.parse(cleanedValue);
                    for(let c of parsedValue) {
                        // console.log("for:", c );
                        if (c.includes(courier)) {
                            console.log("courier:", c);
                                pickupCont.push({ [c]: selectedValue });
                        }
                    }
                }
                console.log("pickupCont:", pickupCont);
            }


            function getCSRFToken() {
                const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/)[1];
                return cookieValue;
            }
            
            // Axios configuration to include CSRF token in headers
            axios.defaults.xsrfCookieName = 'csrftoken';
            axios.defaults.xsrfHeaderName = 'X-CSRFToken';
            axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';

            document.addEventListener('DOMContentLoaded', function() {
                var question = document.getElementById('question')
                var text = document.getElementById('text')

                question.style.display = 'flex';
                text.innerHTML = '';
                text.textContent = "Wybierz opcje";
            });

            function setToSend(event) {

                var wait = document.getElementById('wait');
                wait.style.display = 'flex';

                var question = document.getElementById('question')
                question.style.display = 'flex';

                var datepicker_ = document.getElementById("datepicker").value;
                console.log('datepicker_ *****', datepicker_)
                console.log('pickupCont *****', pickupCont)

                var seller = document.getElementById('seller').getAttribute('data-value');

                var links = document.querySelectorAll('div[name="link"]');

                var context = [];
                links.forEach(function(link) {
                    var value = link.getAttribute('value');
                    console.log('value:', value);
                    let cleanedValue = value
                    .replace(/None/g, 'null')       // Replace None with null
                    .replace(/'/g, '"')             // Replace single quotes with double quotes
                    .replace(/\(\{/g, '{')          // Remove tuple notation (e.g., ( becomes { )
                    .replace(/\}\)/g, '}')
                    .replace(/True/g, 'true')        // Replace True with true
                    .replace(/False/g, 'false');
                    let parsedValue;
                    parsedValue = JSON.parse(cleanedValue);
                    for (let val of parsedValue) {
                        for (let courier of pickupCont) {
                            let key = Object.keys(courier)[0];  // Get the key of the current object
                            if (val["input"]["referenceNumber"] === key) {
                                console.log("Match found:", courier);
                                val["courier"] = {
                                    "name": key,                   
                                    // "hours": courier[key],
                                    "date": `${datepicker_} ${courier[key]}`,          
                                };
                            }
                        }
                    }
                    console.log('parsedValue:', parsedValue);

                    context.push({ parsedValue });
                    // let commandId = parsedValue[0] ? parsedValue[0].commandId : null;
                    // console.log('commandId:', commandId, 'name:', seller);
                    // context.push({ commandId, seller });
                });

                // console.log('context:', context[0]['parsedValue']);
                var serializedContext = JSON.stringify(context[0]['parsedValue']);
                console.log('serializedContext:', serializedContext);
                console.log('datepicker_:', datepicker_);
                if ( datepicker_  === '') {
                    console.log('datepicker_ is null:', datepicker_);
                    showMessage('Wybierz date podjazdu kuriera', 500)
                }
                if ( pickupCont.length  === 0) {
                    console.log('pickupCont is null:', pickupCont);
                    showMessage('Wybierz godzine podjazdu kuriera', 500)
                }

                var url = `/prepare_get_shipment_status_id/${seller}/?ids=` + encodeURIComponent(serializedContext) + '&pickup=' + 'pickup';
                window.location.href = url;
                wait.style.display = 'none';
                question.style.display = 'none';
                
            }


            function getNo() {

                var wait = document.getElementById('wait');
                wait.style.display = 'flex';

                var question = document.getElementById('question')
                question.style.display = 'flex';

                var seller = document.getElementById('seller').getAttribute('data-value');

                var links = document.querySelectorAll('div[name="link"]');

                var context = [];
                links.forEach(function(link) {
                    var value = link.getAttribute('value');
                    console.log('value:', value);
                    let cleanedValue = value
                    .replace(/None/g, 'null')       // Replace None with null
                    .replace(/'/g, '"')             // Replace single quotes with double quotes
                    .replace(/\(\{/g, '{')          // Remove tuple notation (e.g., ( becomes { )
                    .replace(/\}\)/g, '}')
                    .replace(/True/g, 'true')        // Replace True with true
                    .replace(/False/g, 'false');
                    let parsedValue;
                    parsedValue = JSON.parse(cleanedValue);
                    console.log('parsedValue:', parsedValue);
                    context.push({ parsedValue });
                    // let commandId = parsedValue[0] ? parsedValue[0].commandId : null;
                    // console.log('commandId:', commandId);
                    // context.push({ commandId, seller});
                });

                console.log('context:', context[0]['parsedValue']);
                var serializedContext = JSON.stringify(context[0]['parsedValue']);

                var url = `/prepare_get_shipment_status_id/${seller}/?ids=` + encodeURIComponent(serializedContext) + '&pickup=' + 'no_pickup';
                // var seller = document.getElementById('seller').getAttribute('data-value');
                // var url = '/get_orders/' + seller + '/';
                window.location.href = url;
                wait.style.display = 'none';
                question.style.display = 'none';

            }

        </script>
    
    {% endblock %}
</body>
</html>