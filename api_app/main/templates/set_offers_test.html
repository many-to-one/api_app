{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferty</title>    
</head>

{% block content %}
<body>

    <input 
        id="sets-data" 
        style="display:none;"
        value="{{ sets }}"
    />

    <div id="error_13" style="display: none;">
        Nieprawidłowa zawartość EAN
        <button onclick="closeError()">X</button>
    </div>

    <div id="error" style="display: none;">
        Wystąpił błąd, skontaktuj się z właścicielem aplikacji
        <button onclick="closeError()">X</button>
    </div>

    <div id="loadIcon" style="display: none;">
        <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
    </div>

        <div class="list__header_orders">
            <p class="print" id="name" >{{name}}</p>
            <input class="check_o labels" type="button" id="check-all-button">
            <select class="edit_h var_select order" id="status_select" onchange="bulkEdit()">
                <option selected disabled value=" ">Edytuj...</option>
                <option value="PRICE">Cena</option>
                <option value="QUANTITY">Ilość</option>
                <option value="STATUS">Status</option>
                <option value="DELIVERY_PRICE">Cennik dostawy</option>
                <option value="DELIVERY_TIME">Czas wysyłki</option>
                <option value="BULK_PRICE">Cennik hurtowy</option> 
                <option value="VAT_INFO">Informacje o fakturze</option>
                <option value="POST_OFFERS">Wystaw oferty</option>
                <option value="JSON_OFFERS">Zapisz oferty (json)</option>
            </select>

            <input type="search" class="search_h" id="searchInput" placeholder="Szukaj..." onkeyup="searchOffers()">

            <select class="vat__select var_select" id="vatSelect" required>
                <option value="" selected disabled>VAT</option>
                <option value="23.00">23%</option>
                <option value="5.00">5%</option>
            </select>

            <select class="aftersale_select var_select" id="afterSaleSelect" required>
                <option value="" selected disabled>Reklamacja...</option>
                {% for method in aftersale_services.returnPolicies %}
                    <option id="method_{{ forloop.counter }}" value="{{ method.id }}">
                        {{ method.name }}
                    </option>
                {% endfor %}
            </select>

            <select class="delivery_select var_select" id="deliverySelect" required>
                <option value="" selected disabled>Dostawa...</option>
                {% for method in shipping_rates.shippingRates %}
                    <option id="method_{{ forloop.counter }}" value="{{ method.id }}">
                        {{ method.name }}
                    </option>
                {% endfor %}
            </select>
            <button class="jsn_start_absl jsn_start" id="jsnStart" onclick="jsnStartGo()">Załaduj aukcję</button>
            <form class="jsn_h" method="post" id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" id="jsonFile" name="jsonFile" accept="application/json">
                <button type="button" onclick="uploadFile()">Upload</button>
            </form>
        </div>

        <div class="list__header_orders_media">
            <p class="print" id="name" value="{{ name }}">{{name}}</p>
        </div>

        {% if offers_list %}
            <p>{{ offers_list }}</p>
        {% endif %}

        <div id="SetOffersContainer" class="set__offers__cont">

            <div id="messageBox" class="message-box" style="display: none; text-align: center;">
                <span id="messageText"></span>
                <button id="closeButton" class="close-button" onclick="closeMessage()">&times;</button>
            </div>

        {% for offer in result.offers %}

            <div class="set__row">
                <div class="set__offers__line" data-title="{{ offer.name }}" data-id="{{ offer.external.id }}">
                    <div class="conto">
                        <input 
                            class="labels" 
                            id="offer_{{ forloop.counter }}"
                            type="checkbox" 
                            name="selected_items" 
                            data-fulfillment-status="{{ offer.fulfillment.status }}"
                            data-forloop-counter="{{ forloop.counter }}"
                            value="{{ offer.id }}"               
                        >
                        <div class="conto__column">
                            <img class="set__photo" src="{{offer.primaryImage.url}}" alt="">
                            <p class="set__name">{{ offer.name }}</p> 
                            <p>{{offer.publication.status}}</p>
                            <p>{{ offer.id }}</p>
                            <p>{{ id }}</p>
                        </div>

                        <div class="icons__row mt-4">
                            <div class="add__set set__tooltip">
                                <img style="cursor: pointer;" src="{% static 'icons/delete.svg' %}" width="16" alt="">
                                <span class="tooltip__text">Usuń zestawy</span>
                            </div>
                            <div class="add__set set__tooltip" onclick="copyGroupSet('{{ offer.id }}')">
                                <img style="cursor: pointer;" src="{% static 'icons/copy.svg' %}" width="16" alt="">
                                <span class="tooltip__text">Kopiuj zestawy</span>
                            </div>
                            <div class="add__set set__tooltip" onclick="submitGroupCopySet('{{ offer.id }}')">
                                <img style="cursor: pointer;" src="{% static 'icons/paste.svg' %}" width="16" alt="">
                                <span class="tooltip__text">Wklej zestawy</span>
                            </div>
                        </div>
                    </div>    
                </div>

                {% for set in sets %}
                {% if set.1.0.id == offer.id %}

                <div class="set__offers__line" id="oneSet_{{ set.0.set_id }}">
                    <div class="conto">
                        <div class="conto__column" data-set="{{ set }}" id="setRow">

                            <div class="icons__row">
                                <div 
                                    class="add__set set__tooltip"
                                    onclick="deleteSet('{{ set.0.set_id }}')"
                                >
                                    <img style="cursor: pointer;" src="{% static 'icons/delete.svg' %}" width="16" alt="">
                                    <span class="tooltip__text">Usuń zestaw</span>
                                </div>
                                <div 
                                    class="add__set set__tooltip" 
                                    onclick="copySet('{{ set|escapejs }}')"
                                >
                                    <img style="cursor: pointer;" src="{% static 'icons/copy.svg' %}" width="16" alt="">
                                    <span class="tooltip__text">Kopiuj zestaw</span>
                                </div>
                            </div>

                            <div class="conto__row bg-primary-subtle" id="offerSetMain">
                                <img id="offerOneImg_{{ set.0.set_id }}" class="set__photo" src="{{offer.primaryImage.url}}" alt="">
                                <p id="offerOneName_{{ set.0.set_id }}" class="set__name">{{ offer.name }}</p>
                                {% for s in set.1|slice:":1" %}
                                    {% for of in result.offers %}
                                        {% if s.id == of.id %}
                                            <input style="width: 20px;" id="disc__piece_{{ offer.id }}" value="{{ s.requiredQuantity }}" type="text" onchange="setCount('{{ offer.id }}')">
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                                <div class="set__price">
                                    <p class="set__name" id="{{priceOfferFalse}}_{{set.id}}">{{ offer.sellingMode.price.amount }}</p>
                                    <p class="set__name" id="{{pcurrencyOfferFalse}}_{{set.id}}">{{ offer.sellingMode.price.currency }}</p>
                                </div>
                            </div>
                            <hr>
                            
                                <!-- <p class="set__name">tutaj: {{ set.0.set_id }}</p> -->
                                {% for s in set.1|slice:"1:" %}
                                    {% for of in result.offers %}
                                        {% if s.id == of.id %}
                                            <div class="conto__row" id="offerSet">
                                                <img class="set__photo" src="{{of.primaryImage.url}}" alt="">
                                                <p class="set__name">{{ of.name }}</p>
                                                <input style="width: 20px;" id="disc__piece_{{ of.id }}" value="{{ s.requiredQuantity }}" type="text" onchange="setCount('{{ of.id }}')">
                                                <div class="set__price" >
                                                    <p class="set__name" id="{{priceSetFalse}}_{{of.id}}">{{ of.sellingMode.price.amount }}</p>
                                                    <p class="set__name" id="{{pcurrencySetFalse}}_{{of.id}}">{{ of.sellingMode.price.currency }}</p>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}

                                <hr>

                                <div class="discount">
                                    <div class="set__result">
                                        <div class="d-flex gap-2">
                                            <p>zł</p>
                                            <input id="disc__money_{{ set.0.set_id }}" value="{{ set.3.discount }}" type="text">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <input id="disc__percent_{{ set.0.set_id }}" value="{{ set.5.discount_percentage }}" type="text">
                                            <p>%</p>
                                        </div>
                                    </div>
                                    <!-- <label for="">Sztuki</label>
                                    <input id="disc__piece_{{ set.0.set_id }}" value="1" type="text"> -->
                                    <div class="set__result">
                                        <div id="disc__price_{{ set.0.set_id }}" value="{{ set.2.price }}">
                                            <p>Cena do:</p>
                                            <p class="p-1 ml-2 bg-secondary-subtle text-secondary-emphasis">{{ set.2.price }}</p>
                                        </div>
                                        <div>
                                            <p>Cena po:</p>
                                            <p id="afterPrice_{{ set.0.set_id }}" class="p-1 ml-2 bg-info text-white">{{ set.4.price_after }}</p>
                                        </div>
                                    </div>
                                    <button class="jsn_start" onclick="submitDiscount('{{ set.0.set_id }}', '{{ set.2.price }}')">Dodaj</button>
                                </div>

                        </div>

                        <!-- <div class="conto__column"> -->
                            
                            <!-- here Rabat and ... -->
                        <!-- </div> -->
                    </div>
                </div>
                
                {% endif %}
                {% endfor %}

                {% if offer.publication.status == 'ACTIVE' %}
                    <div class="set__offers__line">
                        <div class="icons__row mt-4">
                            <div class="add__set set__tooltip" onclick="submitCopySet('{{ offer.id }}')">
                                <img style="cursor: pointer;" src="{% static 'icons/paste.svg' %}" width="16" alt="">
                                <span class="tooltip__text">Wklej zestaw</span>
                            </div>
                            <div class="add__set set__tooltip" onclick="setsAdd('{{forloop.counter}}')">
                                <img style="cursor: pointer;" src="{% static 'icons/multi_add.svg' %}" width="16" alt="">
                                <span class="tooltip__text">Dodaj multi zestaw</span>
                            </div>
                            <div class="add__set set__tooltip" onclick="setSearch('{{forloop.counter}}')">
                                <img style="cursor: pointer;" src="{% static 'icons/add.svg' %}" width="16" alt="">
                                <span class="tooltip__text">Dodaj pojedyńczy zestaw</span>
                            </div>
                        </div>
                    </div>
                {% endif %}

            </div>

        {% endfor %}


    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>

    <script>

        setMainContainer = []

        document.addEventListener('DOMContentLoaded', function () {
            var setsData = document.getElementById('sets-data').value;
            console.log('setsData', setsData)
            let jsonString = setsData
            .replace(/'/g, '"')  // Replace single quotes with double quotes
            .replace(/True/g, 'true')  // Replace True with true
            .replace(/False/g, 'false');  // Replace False with false        
            console.log(jsonString);
            let array = JSON.parse(jsonString);
            console.log('setsData array',  array);
            setMainContainer.push(array)
        });


        var name = document.getElementById('name').textContent;

        function getCSRFToken() {
            const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/)[1];
            return cookieValue;
        }

        // Function to get CSRF token from cookie
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Check if the cookie name matches the desired name
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // SEARCH OFFERS AND SETS
        function reFresh(forloopCounter) {
            window.location.href = `/set_offers/${name}/`;
        }


        // SEARCH OFFERS AND SETS
        function setSearch(forloopCounter) {
            offerId = document.getElementById('offer_' + forloopCounter).value;
            console.log('offerId', offerId)
            window.location.href = `/set_add/${name}/${offerId}`;
        }


        // ADD SET WITH MORE THAN 1 OFFER
        function setsAdd(forloopCounter) {
            offerId = document.getElementById('offer_' + forloopCounter).value;
            console.log('offerId', offerId)
            window.location.href = `/sets_add/${name}/${offerId}`;
        }



        // USER MESSAGES
        function showMessage(message, status) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;
            messageBox.style.display = 'block';  
            if ( status === 200 ) {
                messageBox.style.backgroundColor = 'green';
            } else if ( status === 300 ) {
                messageBox.style.backgroundColor = 'blue';
            } else {
                messageBox.style.backgroundColor = 'red';
            }

            setTimeout(closeMessage, 3000);
        }

        function closeMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.style.display = 'none';  // Hide the message box
        }


        // DEFINE COUNT FOR EACH ITEM IN SET
        let countArray = []
        function setCount(itemId) {
            console.log('itemId:', itemId);
            var itemCount = document.getElementById('disc__piece_' + itemId).value;
            countArray.push({ [itemId]: itemCount });
            console.log('countArray:', countArray);
        }

        // SUBMIT DISCOUNT
        function submitDiscount(set_id, price) {

            console.log('set_id:', set_id);
            console.log('price:', price);
            var csrftoken = getCSRFToken();
            let discMoney = parseFloat(document.getElementById('disc__money_' + set_id).value);
            const discPercent = parseFloat(document.getElementById('disc__percent_' + set_id).value);
            // const discPiece = parseInt(document.getElementById('disc__piece_' + set_id).value);
            const discPrice = parseInt(document.getElementById('disc__price_' + set_id).value);

            console.log('discMoney:', discMoney);
            console.log('discPercent:', discPercent);

            let priceAfter;

             if (discPercent !== 0) {
                priceAfter = (parseFloat(price) * discPercent) / 100 ; 
                discMoney = priceAfter
                console.log('priceAfter %:', priceAfter, discMoney);
                const afterPrice = document.getElementById('afterPrice_' + set_id);
                afterPrice.textContent = priceAfter.toFixed(2);
            } if (discMoney !== 0) {
                priceAfter = parseFloat(price) - discMoney;
                console.log('priceAfter:', priceAfter);
                const afterPrice = document.getElementById('afterPrice_' + set_id);
                afterPrice.textContent = priceAfter.toFixed(2);
            }

            console.log('discMoney data:', discMoney);

            // Create the data object to send to the server
            const data = {
                set_id: set_id,
                disc__money: discMoney || null,
                disc__percent: discPercent || null,
                // disc__piece: discPiece || 1,
                count_array: countArray || null,
                disc__price: parseFloat(price)|| null, 
            };

            console.log('data:', data);


            axios.post(`/add_discount/${name}/`, data, {
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
                .then(function (response) {                  
                    if (response.data.res.errors) {
                    //    console.log('Error:', response.data.res.errors[0].userMessage); 
                       showMessage(response.data.res.errors[0].userMessage, 500)
                    } else {
                        console.log('Response:', response.data.res); 
                        showMessage(response.data.userMessage, 200)
                    }
                    countArray = []
                })
                .catch(function (error) {
                    console.error('There was an error!', error);
                    alert('There was an error submitting the discount.', error);
                });
        }


        // LIST WITH COPIED OFFER(S)
        let setContainer = []
        function copySet(set) {
            // console.log('SET', set)
            let jsonString = set
            .replace(/'/g, '"')  // Replace single quotes with double quotes
            .replace(/True/g, 'true')  // Replace True with true
            .replace(/False/g, 'false');  // Replace False with false        
            console.log(jsonString);
            let array = JSON.parse(jsonString);
            // console.log('SET array',  array);
            setContainer.push(array)
            // console.log('setContainer copy', setContainer)
            showMessage('Zestaw został skopiowany do schowka', 200)
        }


        // SUBMIT DISCOUNT
        async function submitCopySet(offerId) {

            // Create the data object to send to the server
            const data = {
                set_id: setContainer[0][0]['set_id'],//['set_id'],
                main_offer: offerId,
                disc__money: setContainer[0][3] || null,
                disc__percent: setContainer[0][5] || null,
                count_array: setContainer[0][1] || null,
                disc__price: parseFloat(setContainer[0][2])|| 0, 
                price__after: setContainer[0][4],
                name: name,
            };

            await addCopyOffers (data)
        }


        async function addCopyOffers (data) {

            var csrftoken = getCSRFToken();

            // var setContainer = document.getElementById('oneSet_' + data['set_id']);
            // console.log('setContainer', setContainer);

            // console.log('addCopyOffers in loop', data);

            await axios.post(`/add_copy_offers_one/`, data, {
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
                .then(function (response) {                  
                    if ( response.data.context.status === 'ok' ) {
                        console.log('add_copy_offers_one - ok', response.data.context);
                        showMessage(response.data.context.message, 200)
                        createSetData(response.data.context, data);
                        // setTimeout(reFresh, 1000);
                    } else if ( response.data.context.status === '!ok' ) {
                        showMessage(response.data.context.message, 300)
                        // setTimeout(reFresh, 1000);
                    } else {
                        console.log('postSet', 500);
                        showMessage(response.data.context.message, 500)
                    }
                })
                .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
                showMessage(error, 500)
            });
            setContainer.length = 0

        }


        function createSetData (resp, data) {
            var SetOffersContainer = document.getElementById('SetOffersContainer');

            var setContainer = document.createElement('div'); 
            setContainer.id = `oneSet_${resp.result[0].id}`;

            var conto = document.createElement('div'); 
            conto.className = 'conto';

            var conto__column = document.createElement('div'); 
            conto__column.className = 'conto__column';
            conto__column.id = 'setRow';
            conto__column.dataset = resp;

            var mainOfferImg = document.getElementById('offerOneImg_' + data['set_id']);
            var mainOfferOneName = document.getElementById('offerOneName' + data['set_id']);
            
            var offerOneImg = document.createElement('img');
            offerOneImg.id = `offerOneImg_${resp.result[0].id}`;
            offerOneImg.src = mainOfferImg.src;
            // console.log('setContainer.id', setContainer);

            conto__column.appendChild(offerOneImg);
            conto.appendChild(conto__column);
            setContainer.appendChild(conto);
            SetOffersContainer.appendChild(setContainer);
        }


        async function deleteSet (setId) {
            console.log('deleteSet ++', setId);
            var csrftoken = getCSRFToken();
            var set = document.getElementById('oneSet_' + setId); 

            const resp = await axios.delete(`/delete_set/${name}/${setId}/`,
                {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                }
            )
            .then(function (response) {    
                console.log('deleteSet', response)              
                    if ( response.data.context.status === 'ok' ) {
                        showMessage(response.data.context.message, 200)
                        set.remove()
                        // setTimeout(reFresh, 1000);
                    } else if ( response.data.context.status === '!ok' ) {
                        showMessage(response.data.context.message, 300)
                        // setTimeout(reFresh, 1000);
                    } else {
                        console.log('deleteSet', 500);
                        showMessage(response.data.context.message, 500)
                    }
                })
                .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
                showMessage(error, 500)
            });
        }

        let copyGroupCont = []

        async function copyGroupSet (offerId) {

            // console.log('offerId ++', offerId);
            // console.log('set ++', set);

            for (set of setMainContainer) {
                // console.log('**SET**', set);
                for (s of set) {
                    for (off of s.slice(1, 2)) {
                        for (id of off.slice(0, 1)) {
                            console.log('loop set', id);
                            if ( id['id'] === offerId ) {
                                // console.log('=== set', id);
                                copyGroupCont.push(s)
                            }
                        }
                    }
                }
                console.log('copyGroupCont', copyGroupCont);
                showMessage('Zestaw został skopiowany do schowka', 200)
            }

        }

        async function submitGroupCopySet(offerId) {

            console.log('submitGroupCopySet was called!');

            for ( con of copyGroupCont ) {
                console.log('copyGroupCont in loop', con);
                console.log('copyGroupCont set_id', con[0]['set_id']);
                console.log('copyGroupCont disc__money', con[3]['discount']);
                console.log('copyGroupCont count_array', con[1]);
                const data = {
                    set_id: con[0]['set_id'],
                    main_offer: offerId,
                    disc__money: con[3]['discount'] || null,
                    disc__percent: con[5]['discount_percentage'] || 0,
                    count_array: con[1] || null,
                    disc__price: parseFloat(con[2]['price']) || 0, 
                    price__after: con[4]['price_after'],
                    name: name,
                };

                await addCopyOffers (data)
            }

        }
        
</script>


</body>
{% endblock %}
</html>