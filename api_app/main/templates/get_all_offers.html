{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferty</title>
</head>

{% block content %}
<body>

    <div id="error_13" style="display: none;">
        Nieprawidłowa zawartość EAN
        <button onclick="closeError()">X</button>
    </div>
    
    <div class="offers__cont">

        <!-- <div class="list__header">
            <div class="cont">
                <h1 id="name" value="{{ name }}">{{ name }}</h1>
            </div>
        </div> -->

        <div class="list__header">
            <p class="photo_h">{{name}}</p>
            <p class="name_h">Tytuł</p>
            <p class="stock_h">Stan</p>
            <p class="status_h">Status</p>
            <p class="sale_h">Sprzedaż</p>
            <p class="account_h">Konto</p>
            <p class="post_h">Wystawić produkt</p>
            <!-- <p class="details_h">Szczegóły</p> -->
        </div>

        {% for offer in result.offers %}

            <div class="offers__line">
                <img class="photo" src="{{offer.primaryImage.url}}" alt="">
                <p class="name">{{ offer.name }}</p>
                <p>
                    <input class="stock" type="text" id="stock_{{ offer.id }}" value="{{ offer.stock.available }}">
                    <img id="edit_{{ offer.id }}" class="icon edit__stock" src="{% static 'icons/edit2.png' %}" onclick="editStock('{{ offer.id }}')">
                    <div id="load_{{ offer.id }}" style="display: none;">
                        <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
                    </div>
                </p>
                
                {% if offer.publication.status == 'ACTIVE' %}
                    <img class="icon" src="{% static 'icons/active.png' %}" alt="">
                {% elif offer.publication.status == 'INACTIVE' %}
                    <img class="icon" src="{% static 'icons/inactive.png' %}" alt="">
                {% elif offer.publication.status == 'ENDED' %}
                    <img class="icon" src="{% static 'icons/ended.png' %}" alt="">
                {% endif %}
                <p>{{ offer.stock.sold }}</p>
                <select class="account_select" id="account_select_{{ order.id }}">
                    {% for name in accounts  %}
                        <option id="status_{{ offer.id }}" value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                    <!-- Add more options for other statuses if needed -->
                </select>
                <input id="ean_{{ offer.id }}" type="text" style="display: none;" value="">
                <a id="start_{{ offer.id }}" onclick="getEan('{{ offer.id }}')" style="display: block;">
                    <img class="icon" src="{% static 'icons/post.png' %}" alt="">
                </a>
                <a id="pst_{{ offer.id }}" onclick="postOffer('{{ offer.id }}', document.getElementById('account_select_{{ order.id }}').value)" style="display: none;">
                    <img class="icon" src="{% static 'icons/accept.png' %}" alt="">
                </a>
                <a onclick="getOffer('{{ offer.id }}')">
                    <img class="icon" src="{% static 'icons/enter.png' %}" alt="">
                </a>
            </div>

        {% endfor %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>

    var ean = document.getElementById('ean');
    var listerId = document.getElementById('name');
    var lister = listerId.getAttribute('value');
    var nameId = document.getElementById('name');
    var name = nameId.getAttribute('value');
    var error_13 = document.getElementById('error_13');

        function getCSRFToken() {
            const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/)[1];
            return cookieValue;
        }
        
        // Axios configuration to include CSRF token in headers
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = 'X-CSRFToken';
        axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';

        function editStock(offerId) {
            const load = document.getElementById('load_'+ offerId)
            const edit = document.getElementById('edit_' + offerId);
            load.style.display = 'block';
            edit.style.display = 'none';

            var nameId = document.getElementById('name');
            var name = nameId.getAttribute('value');
            console.log('editStock name clicked', name);

        // Get the value from the input field
        var newStock = document.getElementById('stock_' + offerId).value;
        console.log('newStock', newStock)

        // Make an AJAX request to update the stock value
        axios.patch('/edit_offer_stock/' + offerId + '/', { stock: newStock, name: name })
            .then(function(response) {
                console.log('status', response.data.newValue)
                if(response.status == 200) {
                    // document.getElementById('load_'+ offerId).style.display = 'none';
                    load.style.display = 'none';
                    edit.style.display = 'block';
                    document.getElementById('stock_' + offerId).value = response.data.newValue;
                    // location.reload();
                    console.log('Success', response.data.message)
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });
        }



        function getOffer(offerId) {

        // Get the value from the input field
        var nameId = document.getElementById('name');
        var name = nameId.getAttribute('value');
        console.log('editStock name clicked', name);

        // Make an AJAX request to update the stock value
        axios.post('/get_one_offer/' + offerId + '/', { name: name })
            .then(function(response) {
                console.log('status', response.data.newValue)
                if(response.status == 200) {
                    var context = response.data.context
                    console.log('Success', context)
                    // window.location.href = 'http://127.0.0.1:8000/';
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });
        }

        function getEan (offerId) {
            // Make start button invisible
            var start = document.getElementById('start_' + offerId);
            start.style.display = 'none';

            // Make Post button visible
            var pst = document.getElementById('pst_' + offerId);
            pst.style.display = 'block';

            // Make Ean Input visible
            var ean = document.getElementById('ean_' + offerId);
            ean.style.display = 'block';

            // Make an AJAX request to update the stock value
            axios.post('/get_ean/', { offerId: offerId, name: name})
            .then(function(response) {
                // console.log('status', response.data.newValue)
                if(response.status == 200) {
                    var context = response.data.context.result;
                    console.log('getEan', context);
                    ean.value = context;
                    // window.location.href = 'http://127.0.0.1:8000/';
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });

        }

        function postOffer(offerId, name) {

        // Get the name value of Lister
        // var listerId = document.getElementById('name');
        // var lister = listerId.getAttribute('value');
        console.log('lister chacked', lister);

        console.log('postOffer clicked', offerId);
        var name2 = 'alfapro';
        console.log('account clicked', name);
        var ean = document.getElementById('ean_' + offerId);

        // Make an AJAX request to update the stock value
        axios.post('/post_new_offer/' + offerId + '/', { name: name2, lister: lister, ean: ean.value })
            .then(function(response) {
                console.log('status', response.data)
                if(response.status == 200) {
                    if(response.data.message == 'Success') {
                        // var context = response.data.context
                        console.log('Success post_new_offer')
                        // window.location.reload();
                        // window.location.href = 'http://127.0.0.1:8000/';
                    } else {
                        console.log('ERROR 13')
                        error_13.style.display = 'flex';
                    }
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
                // window.location.reload();
            });
        }

    </script>

<script>
    function closeError() {
        var errorElement = document.getElementById("error_13");
        if (errorElement) {
            errorElement.style.display = "none";
            console.log('CLOSE');
        }
    }
</script>

</body>
{% endblock %}
</html>