{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferty</title>
</head>

{% block content %}
<body>

    <div id="error_13" style="display: none;">
        Nieprawidłowa zawartość EAN
        <button onclick="closeError()">X</button>
    </div>

    <div id="error" style="display: none;">
        Wystąpił błąd, skontaktuj się z właścicielem aplikacji
        <button onclick="closeError()">X</button>
    </div>

    
    <div class="offers__cont">

        <!-- <div class="list__header">
            <div class="cont">
                <h1 id="name" value="{{ name }}">{{ name }}</h1>
            </div>
        </div> -->

        <div class="list__header_orders">
            <p class="print" id="name" value="{{ name }}">{{name}}</p>
            <select class="edit_h var_select order" id="status_select" onchange="bulkEdit()">
                <option selected value=" ">Edytuj...</option>
                <option value="PRICE">Cena</option>
                <option value="QUANTITY">Ilość</option>
                <option value="STATUS">Status</option>
                <option value="DELIVERY_PRICE">Cennik dostawy</option>
                <option value="DELIVERY_TIME">Czas wysyłki</option>
                <option value="BULK_PRICE">Cennik hurtowy</option> 
                <option value="VAT_INFO">Informacje o fakturze</option>
            </select>
            <input class="check_o labels" type="button" id="check-all-button">
            <p class="name_h">Tytuł</p>
            <p class="stock_h">Stan</p>
            <p class="status_h">Status</p>
            <p class="sale_h">Sprzedaż</p>
            <p class="account_h">Konto</p>
            <p class="post_h">Wystawić produkt</p>
            <form class="csv_h" action="{% url 'edit_offers_csv' name %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="file" placeholder="csv">CSV</input>
                <button >Upload</button>
            </form>
        </div>

        <div class="list__header_orders_media">
            <p class="print" id="name" value="{{ name }}">{{name}}</p>
        </div>

        {% for offer in result.offers %}

            <div class="offers__line">
                <input 
                    class="labels" 
                    type="checkbox" 
                    name="selected_items" 
                    data-fulfillment-status="{{ order.fulfillment.status }}"
                    data-order-data="{{ order.id }}"
                    value="{{ offer.id }}"
                        
                    >
                <img class="photo" src="{{offer.primaryImage.url}}" alt="">
                <p class="name">{{ offer.name }}</p>
                <p class="costs_o_cont">
                    <input class="stock" type="text" id="stock_{{ offer.id }}" value="{{ offer.stock.available }}">
                    <img id="edit_{{ offer.id }}" class="icon edit__stock" src="{% static 'icons/edit2.png' %}" onclick="editStock('{{ offer.id }}')">
                    <div id="load_{{ offer.id }}" style="display: none;">
                        <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
                    </div>
                </p>
                <p class="costs_o_cont">
                    <input class="costs_o" type="text" id="costs_{{ offer.id }}" value="{{ offer.sellingMode.price.amount }}">
                    <p class="currency_o" id="currency_{{ offer.id }}" value="{{ offer.sellingMode.price.currency }}">{{ offer.sellingMode.price.currency }}</p>
                    <img id="c_edit_{{ offer.id }}" class="icon edit__stock" src="{% static 'icons/edit2.png' %}" onclick="editCosts('{{ offer.id }}')">
                    <div id="c_load_{{ offer.id }}" style="display: none;">
                        <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
                    </div>
                </p>
                
                {% if offer.publication.status == 'ACTIVE' %}
                    <img class="icon" src="{% static 'icons/active.png' %}" alt="">
                {% elif offer.publication.status == 'INACTIVE' %}
                    <img class="icon" src="{% static 'icons/inactive.png' %}" alt="">
                {% elif offer.publication.status == 'ENDED' %}
                    <img class="icon" src="{% static 'icons/ended.png' %}" alt="">
                {% endif %}
                <p>{{ offer.stock.sold }}</p>
                <select class="account_select" id="account_select_{{ order.id }}_{{ forloop.counter }}">
                    {% for nameIs in accounts  %}
                        <option id="status_{{ offer.id }}_{{ forloop.counter }}" value="{{ nameIs }}">
                            {{ nameIs }}
                        </option>
                    {% endfor %}  
                    <!-- Add more options for other statuses if needed -->
                </select>

                <input id="ean_{{ offer.id }}_{{ forloop.counter }}" type="text" style="display: none;" value="">

                <a id="start_{{ offer.id }}_{{ forloop.counter }}" onclick="getEan('{{ offer.id }}', '{{ forloop.counter }}')" style="display: block;">
                    <img class="icon" src="{% static 'icons/post.png' %}" alt="">
                </a>

                <a id="pst_{{ offer.id }}_{{ forloop.counter }}" onclick="postOffer('{{ offer.id }}', '{{ forloop.counter }}', document.getElementById('account_select_{{ order.id }}_{{ forloop.counter }}').value)" style="display: none;">
                    <img id="pstIcon_{{ offer.id }}_{{ forloop.counter }}" class="icon" src="{% static 'icons/accept.png' %}" alt="">
                    <div id="loadPst_{{ offer.id }}_{{ forloop.counter }}" style="display: none;">
                        <img class="icon loading" src="{% static 'icons/load.png' %}" alt="">
                    </div>
                </a>

                <a id="dscr_{{ offer.id }}_{{ forloop.counter }}" onclick="getDescr('{{ offer.id }}', '{{ forloop.counter }}')">
                    <img class="icon" src="{% static 'icons/enter.png' %}" alt="">
                </a>
            </div>

        {% endfor %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>
    <script>

    var ean = document.getElementById('ean');
    var listerId = document.getElementById('name');
    var lister = listerId.getAttribute('value');
    var nameId = document.getElementById('name');
    var name = nameId.getAttribute('value');
    var error_13 = document.getElementById('error_13');
    var error = document.getElementById('error');

        // function getCSRFToken() {
        //     const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/)[1];
        //     return cookieValue;
        // }

        // Function to get CSRF token from cookie
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Check if the cookie name matches the desired name
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }




        document.getElementById('check-all-button').addEventListener('click', function() {
            // Select all checkboxes with the name 'selected_items'
            var checkboxes = document.querySelectorAll('input[name="selected_items"]');
            
            // Loop through each checkbox
            checkboxes.forEach(function(checkbox) {
                // Check only if the fulfillment status is 'NEW' and it is currently unchecked
                if ( !checkbox.checked) {
                    checkbox.checked = true;
                    console.log('checkbox', checkbox.value)
                }
                else if (checkbox.checked) {
                    checkbox.checked = false;
                }
            });
        });



        function getDescr(offerId, counter) {

            console.log('getDescr - lister, ean, counter', lister, counter);

            var csrftoken = getCookie('csrftoken');

            var url = `/get_description/${offerId}/${lister}`;
            window.location.href = url;

            // axios.post('/get_description/' + offerId + '/', { lister: lister }, {
            //     headers: {
            //             'X-CSRFToken': csrftoken
            //         }
            // })

        }
        

        function postOfferTest(offerId, counter, selectedValue) {
            // Your existing postOffer logic here

            console.log('offerId - account:', counter);

            // Perform other actions based on the selected value
        }

        function editStock(offerId) {

            // Obtain CSRF token from cookie
            var csrftoken = getCookie('csrftoken');

            const load = document.getElementById('load_'+ offerId)
            const edit = document.getElementById('edit_' + offerId);
            load.style.display = 'block';
            edit.style.display = 'none';

            var nameId = document.getElementById('name');
            var name = nameId.getAttribute('value');
            console.log('editStock name clicked', name);

        // Get the value from the input field
        var newStock = document.getElementById('stock_' + offerId).value;
        console.log('newStock', newStock)

        // Make an AJAX request to update the stock value
        axios.patch('/edit_offer_stock/' + offerId + '/', { stock: newStock, name: name }, {
            headers: {
                    'X-CSRFToken': csrftoken
                }
        })
            .then(function(response) {
                console.log('status', response.data.newValue)
                if(response.status == 200) {
                    // document.getElementById('load_'+ offerId).style.display = 'none';
                    load.style.display = 'none';
                    edit.style.display = 'flex';
                    document.getElementById('stock_' + offerId).value = response.data.newValue;
                    // location.reload();
                    // console.log('Success', response.data.message)
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });
        }



        function editCosts(offerId) {

            // Obtain CSRF token from cookie
            var csrftoken = getCookie('csrftoken');

            const load = document.getElementById('c_load_'+ offerId)
            const edit = document.getElementById('c_edit_' + offerId);
            load.style.display = 'block';
            edit.style.display = 'none';

            var nameId = document.getElementById('name');
            var name = nameId.getAttribute('value');
            console.log('editStock name clicked', name);

            // Get the value from the input field
            var newCosts = document.getElementById('costs_' + offerId).value;
            console.log('newCosts', newCosts)

            var getCurrency = document.getElementById('currency_' + offerId).textContent.trim();
            console.log('getCurrency', getCurrency)

            // Make an AJAX request to update the stock value
            axios.patch('/edit_offer_stock/' + offerId + '/', { costs: newCosts, name: name }, {
            headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(function(response) {
                console.log('status', response.data.newCosts)
                if(response.status == 200) {
                    // document.getElementById('load_'+ offerId).style.display = 'none';
                    load.style.display = 'none';
                    edit.style.display = 'flex';
                    document.getElementById('costs_' + offerId).value = response.data.newCosts;
                    // location.reload();
                    // console.log('Success', response.data.message)
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });
        }



        function getOffer(offerId) {

        // Obtain CSRF token from cookie
        var csrftoken = getCookie('csrftoken');

        // Get the value from the input field
        var nameId = document.getElementById('name');
        var name = nameId.getAttribute('value');
        console.log('editStock name clicked', name);

        // Make an AJAX request to update the stock value
        axios.post('/get_one_offer/' + offerId + '/', { name: name }, {
            headers: {
                    'X-CSRFToken': csrftoken
                }
        })
            .then(function(response) {
                console.log('status', response.data.newValue)
                if(response.status == 200) {
                    var context = response.data.context
                    // console.log('Success', context)
                    // window.location.href = 'http://127.0.0.1:8000/';
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });
        }

        function getEan (offerId, counter) {

            console.log('getEan offerId', offerId, counter, name);

            // Obtain CSRF token from cookie
            var csrftoken = getCookie('csrftoken');

            // Make start button invisible
            var start = document.getElementById('start_' + offerId + '_' + counter);
            start.style.display = 'none';

            // Make Post button visible
            var pst = document.getElementById('pst_' + offerId + '_' + counter);
            pst.style.display = 'block';

            // Make Ean Input visible
            var ean = document.getElementById('ean_' + offerId + '_' + counter);
            ean.style.display = 'block';

            // Make an AJAX request to update the stock value
            axios.post('/get_ean/', { offerId: offerId, name: name}, {
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(function(response) {
                // console.log('status', response.data.newValue)
                if(response.status == 200) {
                    var context = response.data.context.result;
                    console.log('getEan', context);
                    ean.value = context;
                    // window.location.href = 'http://127.0.0.1:8000/';
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
            });

            return ean.value;

        }

//         document.getElementById('account_select_{{ order.id }}').addEventListener('change', function() {
//     var selectedValue = this.value; // Get the selected value

//     // Now you can use the selected value in your logic
//     console.log('Selected account:', selectedValue);

//     // You can perform other actions based on the selected value
//     // For example, you can make an AJAX request or update other parts of the page
// });


        function postOffer(offerId, counter, name) {

        // Obtain CSRF token from cookie
        var csrftoken = getCookie('csrftoken');

        // var posto = document.getElementById('status_' + offerId)
        // console.log('posto', posto)
        // var postVal = posto.value;

        const loadPst = document.getElementById('loadPst_' + offerId + '_' + counter)
        const pstIcon = document.getElementById('pstIcon_' + offerId + '_' + counter);
        loadPst.style.display = 'block';
        pstIcon.style.display = 'none';

        // Get the name value of Lister
        // var listerId = document.getElementById('name');
        // var lister = listerId.getAttribute('value');
        // console.log('lister chacked', lister);

        var ean = document.getElementById('ean_' + offerId + '_' + counter);
        console.log('postOffer - name lister, ean, clicked', name, lister, ean.value);

        axios.post('/post_new_offer/' + offerId + '/', { name: name, lister: lister, ean: ean.value }, {
            headers: {
                    'X-CSRFToken': csrftoken
                }
        })
            .then(function(response) {
                console.log('status', response.data)
                if(response.status == 200) {
                    if(response.data.message == 'Success') {
                        loadPst.style.display = 'none';
                        pstIcon.style.display = 'flex';
                        // var context = response.data.context
                        console.log('Success post_new_offer')
                        // window.location.reload();
                        // window.location.href = '/get_all_offers/' + name + '/';
                    } else {
                        console.log('ERROR 13')
                        error_13.style.display = 'flex';
                    }
                }
            })
            .catch(function(error) {
                // Handle error
                console.error('Error updating stock:', error);
                error.style.display = 'flex';
                // window.location.reload();
            });
        }

    </script>

<script>
    function closeError() {
        var errorElement = document.getElementById("error_13");
        var errorMain = document.getElementById("error");
        if ( errorElement ) {
            errorElement.style.display = "none";
            console.log('CLOSE');
        } else if ( errorMain ) {
            errorMain.style.display = "none";
        }
    }
</script>


<script>
    function bulkEdit() {
        var checkboxes = document.querySelectorAll('input[name="selected_items"]');

        // Initialize an empty array to store the checked checkbox values
        var checkedItems = [];

        // Iterate over each checkbox
        checkboxes.forEach(function(checkbox) {
            // Check if the checkbox is checked
            if (checkbox.checked) {
                console.log('checkbox =>', checkbox.value)
                checkedItems.push(checkbox.value);
            }
        });

        var selectedStatus = document.getElementById('status_select').value;
        console.log('selectedStatus, name =>', selectedStatus, name)

        var url = `/bulk_edit/${name}/${selectedStatus}/?ids=` + checkedItems;
        window.location.href = url;

    }
</script>

</body>
{% endblock %}
</html>